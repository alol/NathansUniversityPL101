<html>
<head>
  <meta charset="utf-8">
  <title>Mocha Tests</title>
  <link rel="stylesheet"
    href="http://nathansuniversity.com/css/mocha.css" />
  <script src=
    "http://nathansuniversity.com/js/jquery-1.7.1.min.js">
  </script>
  <script src=
    "http://nathansuniversity.com/js/chai.js">
  </script>
  <script src="http://nathansuniversity.com/js/mocha.js">
  </script>
  <script src="parser.js"></script> 
  <script>mocha.setup('tdd')</script>
  <script>
var assert = chai.assert;

// A half-baked implementation of evalScheem
var evalScheem = function (expr, env) {
    // Numbers evaluate to themselves
    if (typeof expr === 'number') {
        return expr;
    }
    // Strings are variable references
    if (typeof expr === 'string') {
        return env[expr];
    }
    // Look at head of list for operation
    switch (expr[0]) {
        case '+':
            var expr1 = evalScheem(expr[1], env);
            var expr2 = evalScheem(expr[2], env);
            if (typeof expr1 !== "number")
                throw new Error("Parameter 1 is not a number")
            else if (typeof expr2 !== "number")
                throw new Error("Parameter 2 is not a number")
            return expr1 + expr2;
        case '-':
            var expr1 = evalScheem(expr[1], env);
            var expr2 = evalScheem(expr[2], env);
            if (typeof expr1 !== "number")
                throw new Error("Parameter 1 is not a number")
            else if (typeof expr2 !== "number")
                throw new Error("Parameter 2 is not a number")
            return expr1 - expr2;
        case '*':
            var expr1 = evalScheem(expr[1], env);
            var expr2 = evalScheem(expr[2], env);
            if (typeof expr1 !== "number")
                throw new Error("Parameter 1 is not a number")
            else if (typeof expr2 !== "number")
                throw new Error("Parameter 2 is not a number")
            return expr1 * expr2;
        case '/':
            var expr1 = evalScheem(expr[1], env);
            var expr2 = evalScheem(expr[2], env);
            if (typeof expr1 !== "number")
                throw new Error("Parameter 1 is not a number")
            else if (typeof expr2 !== "number")
                throw new Error("Parameter 2 is not a number")
            return expr1 / expr2;
        case 'quote':
            return expr[1];
        case 'define':
            if(!env[expr[1]])
                    env[expr[1]] = evalScheem(expr[2], env);
            return 0;
        case 'set!':
            env[expr[1]] = evalScheem(expr[2], env);
            return 0;   
        case 'begin':
            var retVal;
            for(var i = 0; i < expr.length; i++) {
                retVal = evalScheem(expr[i], env);
            }
            return retVal;
        case '<':
            var eq =
                (evalScheem(expr[1], env) <
                 evalScheem(expr[2], env));
            if (eq) return '#t';
            return '#f';
         case 'cons':
            var e2 = evalScheem(expr[2]);
            e2.unshift(evalScheem(expr[1]));
            return e2;
        case 'car':
            return evalScheem(expr[1]).shift();
        case 'cdr':
            return evalScheem(expr[1]).slice(1);
        case '=':
            var eq =
                (evalScheem(expr[1], env) ===
                 evalScheem(expr[2], env));
            if (eq) return '#t';
            return '#f';
        case 'if':
            if(evalScheem(expr[1]) === '#t')
                return evalScheem(expr[2]);
            return evalScheem(expr[3]);
        default:
            throw new Error("undefined operation!");

    }
};

// Some unit tests

suite('quote', function() {
    test('a number', function() {
        assert.deepEqual(
            evalScheem(['quote', 3], {}),
            3
        );
    });
    test('an atom', function() {
        assert.deepEqual(
            evalScheem(['quote', 'dog'], {}),
            'dog'
        );
    });
    test('a list', function() {
        assert.deepEqual(
            evalScheem(['quote', [1, 2, 3]], {}),
            [1, 2, 3]
        );
    });
});
suite('add', function() {
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['+', 3, 5], {}),
            8
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['+', 3, ['+', 2, 2]], {}),
            7
        );
    });
    test('2 + 2 = 4', function() {
        assert.deepEqual(
            evalScheem(['+', 2, 2], {}),
            4
        );
    });
    test('a dog and a cat', function() {
        assert.throws(function() {
            evalScheem(['+', 'dog', 'cat'], {});
        });
    });
});
suite('subtract', function() {
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['-', 8, 5], {}),
            3
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['-', 3, ['+', 2, 2]], {}),
            -1
        );
    });
    test('2 - 2 = 0', function() {
        assert.deepEqual(
            evalScheem(['-', 2, 2], {}),
            0
        );
    });
    test('a dog minus a cat', function() {
        assert.throws(function() {
            evalScheem(['-', 'dog', 'cat'], {});
        });
    });
});
suite('multiply', function() {
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['*', 8, 5], {}),
            40
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['*', 3, ['+', 2, 2]], {}),
            12
        );
    });
    test('2 * 2 = 0', function() {
        assert.deepEqual(
            evalScheem(['*', 2, 2], {}),
            4
        );
    });
    test('a dog times a cat', function() {
        assert.throws(function() {
            evalScheem(['*', 'dog', 'cat'], {});
        });
    });
});
suite('divide', function() {
    test('two numbers', function() {
        assert.deepEqual(
            evalScheem(['/', 8, 2], {}),
            4
        );
    });
    test('a number and an expression', function() {
        assert.deepEqual(
            evalScheem(['/', 40, ['+', 2, 2]], {}),
            10
        );
    });
    test('2 / 2 = 0', function() {
        assert.deepEqual(
            evalScheem(['/', 2, 2], {}),
            1
        );
    });
    test('1 / 2 = 0.5', function() {
        assert.deepEqual(
            evalScheem(['/', 1, 2], {}),
            0.5
        );
    });
    test('a dog divided by a cat', function() {
        assert.throws(function() {
            evalScheem(['/', 'dog', 'cat'], {});
        });
    });
});
suite('variables', function() {
    test('where x is 1, x + x = 2', function() {
        assert.deepEqual(
            evalScheem(['+', 'x', 'x'], {x: 1}),
            2
        );
    });
    test('define x to a number', function() {
        var env = {};
        evalScheem(['define', 'x', 1], env);
        assert.deepEqual(
            env,
            {x:1}
        );
    });
    test('define x to the result of an expression', function() {
        var env = {};
        evalScheem(['define', 'x', ['*', 20, 5]], env);
        assert.deepEqual(
            env,
            {x:100}
        );
    });
    test('overwrite x to another number', function() {
        var env = {x:1};
        evalScheem(['set!', 'x', 100], env);
        assert.deepEqual(
            env,
            {x:100}
        );
    });
});
suite('begin', function() {
    test('return the last expression', function() {
        assert.deepEqual(
            evalScheem(['begin', 1, 2, 3], {}),
            3
        );
    });
    test('define and then retrieve a variable', function() {
        assert.deepEqual(
            evalScheem(['begin', ['define', 'x', 5], 'x'], {}),
            5
        );
    });
});
suite('less than', function() {
    test('1 < 2 should return "#t"', function() {
        assert.deepEqual(
            evalScheem(['<', 1, 2], {}),
            "#t"
        );
    });
    test('2 < 2 should return "#f"', function() {
        assert.deepEqual(
            evalScheem(['<', 2, 2], {}),
            "#f"
        );
    });
    test('3 < 2 should return "#f"', function() {
        assert.deepEqual(
            evalScheem(['<', 3, 2], {}),
            "#f"
        );
    });
});
suite('cons', function() {
    test('add an atom to a list', function() {
        assert.deepEqual(
            evalScheem(['cons', 1, ['quote', [2, 3]]]),
            [1, 2, 3]
        );
    });
    test('add a list to a list', function() {
        assert.deepEqual(
            evalScheem(['cons', ['quote', [1, 2]], ['quote', [2, 3]]]),
            [[1, 2], 2, 3]
        );
    });
});
suite('car', function() {
    test('head of a list (atom)', function() {
        assert.deepEqual(
            evalScheem(['car', ['quote',[1, 2, 3]]]),
            1
        );
    });
    test('head of a list (list)', function() {
        assert.deepEqual(
            evalScheem(['car', ['quote',[[1, 'a'], 2, 3]]]),
            [1, 'a']
        );
    });
});
suite('cdr', function() {
    test('head removed of a list (atom)', function() {
        assert.deepEqual(
            evalScheem(['cdr', ['quote',[1, 2, 3]]]),
            [2, 3]
        );
    });
    test('head removed of a list (list)', function() {
        assert.deepEqual(
            evalScheem(['cdr', ['quote',[[1, 'a'], ['b', 2, 3]]]]),
            [['b', 2, 3]]
        );
    });
});
suite('equals', function() {
    test('1 = 2 should return "#f"', function() {
        assert.deepEqual(
            evalScheem(['=', 1, 2], {}),
            "#f"
        );
    });
    test('2 = 2 should return "#t"', function() {
        assert.deepEqual(
            evalScheem(['=', 2, 2], {}),
            "#t"
        );
    });
});
suite('if', function() {
    test('if 1 = 2, 0, else 1', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 1, 2], 0, 1]),
            1
        );
    });
    test('if 2 = 2, 0, else 1', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 2, 2], 0, 1]),
            0
        );
    });
    test('only true branch is evaluated', function() {
        assert.deepEqual(
            evalScheem(['if', ['=', 2, 2], 1, 'error']),
            1
        );
    });
});
suite('parse', function() {
    test('a number', function() {
        assert.deepEqual(
            SCHEEM.parse('42'),
            42
        );
    });
    test('a variable', function() {
        assert.deepEqual(
            SCHEEM.parse('x'),
            'x'
        );
    });
    test('an expression', function() {
        assert.deepEqual(
            SCHEEM.parse('(+ 1 1)'),
            ['+', 1, 1]
        );
    });
    test('a nested expression', function() {
        assert.deepEqual(
            SCHEEM.parse('(* 50 (+ 1 1))'),
            ['*', 50, ['+', 1, 1]]
        );
    });
    test('a quote', function() {
        assert.deepEqual(
            SCHEEM.parse('(quote (1 2 3))'),
            ['quote', [1, 2, 3]]
        );
    });
    test('a shorthand quote', function() {
        assert.deepEqual(
            SCHEEM.parse("'(1 2 3)"),
            ['quote', [1, 2, 3]]
        );
    });
});

  </script>
  <script>
    $(function(){
      mocha.run();
    });
  </script>
</head>
<body>
  <div id="mocha"></div>
</body>
</html>
